<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Digital Closet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- External Libraries -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <?!= include('stylesheet'); ?>
</head>
<body>

  <div id="loading" style="display: none;"><div class="spinner-border text-dark" role="status"><span class="sr-only">Loading...</span></div></div>

  <div class="main-container">
    <header class="header">
      <h1>Digital Closet</h1>
      <div class="header-actions">
        <button class="btn btn-warning" onclick="openAiConsultModal()">
          <span class="d-none d-lg-inline">AIに相談</span>
          <span class="d-lg-none">AI相談</span>
        </button>
        <button class="btn btn-danger" onclick="openStyleModal()">
          <span class="d-none d-lg-inline">AIスタイリスト</span>
          <span class="d-lg-none">AI提案</span>
        </button>
        <button class="btn btn-info" onclick="openCoordModal()">
          <span class="d-none d-lg-inline">コーデ作成</span>
          <span class="d-lg-none">コーデ</span>
        </button>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="openItemModal()">
            <span class="d-none d-lg-inline">＋ 新規アイテム</span>
            <span class="d-lg-none">＋ 新規</span>
          </button>
          <button class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown"></button>
          <div class="dropdown-menu dropdown-menu-right">
            <a class="dropdown-item" href="#" onclick="openAiRegisterModal(event)">AIで下書きを作成</a>
          </div>
        </div>
      </div>
    </header>

    <ul class="nav nav-tabs nav-fill" id="myTab" role="tablist">
      <li class="nav-item"><a class="nav-link active" id="closet-tab" data-toggle="tab" href="#closet" role="tab">Closet</a></li>
      <li class="nav-item"><a class="nav-link" id="calendar-tab" data-toggle="tab" href="#calendar" role="tab">Calendar</a></li>
      <li class="nav-item"><a class="nav-link" id="disposed-tab" data-toggle="tab" href="#disposed" role="tab">廃棄済み</a></li>
      <li class="nav-item"><a class="nav-link" id="dashboard-tab" data-toggle="tab" href="#dashboard" role="tab">Dashboard</a></li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="closet" role="tabpanel">
        <div class="controls mt-4 mb-4">
          <div class="form-row align-items-center">
            <div class="form-group col-12"><input type="text" id="searchInput" class="form-control" placeholder="キーワード検索..."></div>
            <div class="form-group col-6 col-md-3"><select id="categoryFilter" class="form-control"></select></div>
            <div class="form-group col-6 col-md-3"><select id="colorFilter" class="form-control"></select></div>
            <div class="form-group col-6 col-md-3"><select id="seasonFilter" class="form-control"><option value="">シーズン</option><option value="春">春</option><option value="夏">夏</option><option value="秋">秋</option><option value="冬">冬</option></select></div>
            <div class="form-group col-6 col-md-3"><select id="sortOrder" class="form-control"></select></div>
          </div>
           <div class="d-flex justify-content-between align-items-center mt-3 px-2">
               <div class="btn-group btn-group-toggle" data-toggle="buttons">
                   <label class="btn btn-outline-secondary active"><input type="radio" name="view" id="cardView" autocomplete="off" checked> カード</label>
                   <label class="btn btn-outline-secondary"><input type="radio" name="view" id="listView" autocomplete="off"> リスト</label>
               </div>
                <div class="text-secondary"><span id="itemCount">0</span> 件</div>
           </div>
        </div>
        <div id="itemsGrid" class="row"></div>
      </div>
      
      <div class="tab-pane fade" id="calendar" role="tabpanel">
        <div class="controls mt-4 mb-4 p-3">
          <div id="calendar-header" class="d-flex justify-content-between align-items-center">
            <button id="prev-month-btn" class="btn btn-outline-secondary">&lt;</button>
            <h4 id="calendar-month-year" class="mb-0"></h4>
            <button id="next-month-btn" class="btn btn-outline-secondary">&gt;</button>
          </div>
        </div>
        <div id="calendar-grid-container" class="table-responsive-sm">
          <div id="calendar-weekdays" class="calendar-grid"></div>
          <div id="calendar-days" class="calendar-grid"></div>
        </div>
      </div>

      <div class="tab-pane fade" id="disposed" role="tabpanel">
        <div class="mt-4 table-responsive-sm">
          <div id="disposedItemsGrid"></div>
        </div>
      </div>
      
      <div class="tab-pane fade" id="dashboard" role="tabpanel">
        <div class="dashboard-grid mt-4">
            <div class="chart-container" id="statsSummary" style="grid-column: 1 / -1;"></div>
            
            <!-- ★改善: カテゴリフィルターを追加 -->
            <div class="chart-container">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5>着用回数 Top 10</h5>
                <select id="wearRankCategoryFilter" class="form-control form-control-sm" style="width: auto;">
                  <option value="">すべての種類</option>
                  <!-- Options will be populated by JS -->
                </select>
              </div>
              <ul id="wearRank" class="rank-list"></ul>
            </div>
            
            <div class="chart-container">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5>ご無沙汰アイテム Top 10</h5>
                <select id="neglectedSortOrder" class="form-control form-control-sm" style="width: auto;">
                  <option value="last_worn">ご無沙汰順</option>
                  <option value="wear_count">着用回数少ない順</option>
                </select>
              </div>
              <ul id="neglectedItemsList" class="rank-list"></ul>
            </div>

            <div class="chart-container"><h5>ブランド別 投資額 Top 10</h5><ul id="brandRank" class="rank-list"></ul></div>
            <div class="chart-container"> <canvas id="categoryChart"></canvas> </div>
            <div class="chart-container"> <canvas id="colorChart"></canvas> </div>
            <div class="chart-container" style="grid-column: 1 / -1;"> <canvas id="yearlyInvestmentChart"></canvas> </div>
            <div class="chart-container" style="grid-column: 1 / -1;">
              <div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mb-2">
                  <h5 class="mb-2 mb-sm-0">保存したコーデ</h5>
                  <select id="coordFilterItem" class="form-control" style="width: auto; max-width: 250px;"></select>
              </div>
              <div id="saved-coords" class="rank-list"></div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="itemModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title" id="modalTitle">アイテム情報</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
    <div class="modal-body">
      <input type="hidden" id="itemId">
      <div class="form-group"><label>名前:</label><input type="text" id="itemName" class="form-control" required></div>
      <div class="form-group">
        <label>画像:</label>
        <div>
          <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
          <input type="hidden" id="itemImageUrl">
          <button type="button" class="btn btn-outline-secondary" id="imageUploadBtn">
            <i class="fas fa-paperclip"></i> 画像を選択
          </button>
          <div id="imageUploadPreviewContainer" class="mt-2">
            <img id="imageUploadPreview" src="" style="max-width: 150px; max-height: 150px; display: none; border-radius: 8px;">
          </div>
        </div>
      </div>
      <div class="form-group"><label>種類:</label><select id="itemCategory" class="form-control" required></select></div>
      <div class="form-group"><label>色:</label><select id="itemColor" class="form-control" required></select></div>
      <div class="form-group"><label>ブランド:</label><input type="text" id="itemBrand" class="form-control"></div>
      <div class="form-group"><label>価格:</label><input type="number" id="itemPrice" class="form-control"></div>
      <div class="form-group"><label>購入年:</label><input type="number" id="itemPurchaseYear" class="form-control"></div>
      <div class="form-group"><label>着用シーズン:</label><div id="seasonCheckboxes">
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="seasonSpring" value="春"><label class="form-check-label" for="seasonSpring">春</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="seasonSummer" value="夏"><label class="form-check-label" for="seasonSummer">夏</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="seasonAutumn" value="秋"><label class="form-check-label" for="seasonAutumn">秋</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="seasonWinter" value="冬"><label class="form-check-label" for="seasonWinter">冬</label></div>
      </div></div>
      <div class="form-group"><label>フォーマル度:</label><select id="formality" class="form-control"><option value="1">1 : カジュアル</option><option value="2">2 : ややカジュアル</option><option value="3" selected>3 : 中間</option><option value="4">4 : ややフォーマル</option><option value="5">5 : フォーマル</option></select></div>
      <div class="form-group"><label>素材:</label><input type="text" id="itemMaterial" class="form-control"></div>
      <div class="form-group"><label>柄:</label><input type="text" id="itemPattern" class="form-control"></div>
      <div class="form-group"><label>メモ:</label><textarea id="itemMemo" class="form-control" rows="3"></textarea></div>
    </div>
    <div class="modal-footer justify-content-between">
      <button type="button" id="aiUpdateBtn" class="btn btn-outline-danger" onclick="initiateAiUpdate()">AIで画像から更新</button>
      <div>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
        <button type="button" id="saveItemBtn" class="btn btn-primary" onclick="saveItem()">保存する</button>
      </div>
    </div>
  </div></div></div>

  <div class="modal fade" id="coordModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">コーディネート作成</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
    <div class="modal-body"><p>アイテムを選択してください</p><div id="coord-item-list"></div></div>
    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button><button type="button" id="saveCoordBtn" class="btn btn-info">このコーデを保存</button></div>
  </div></div></div>

  <div class="modal fade" id="styleModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">AI Stylist</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
        <div class="modal-body">
          <div class="row h-100">
            <div class="col-md-5 d-flex flex-column">
              <h6>1. AIへの要望（任意）</h6>
              <textarea id="styleRequest" class="form-control mb-3" rows="2" placeholder="例：公園に行くのでカジュアルに、寒くないように、デートに着ていきたい 等"></textarea>
              <h6 class="mt-2">2. 基準にするアイテムを選んでください</h6>
              <div id="style-base-item-list"></div>
            </div>
            <div class="col-md-7 d-flex flex-column">
              <h6 class="mt-2 mt-md-0">3. AIからの提案</h6>
              <div id="style-suggestion-list" class="flex-grow-1"><p class="text-muted">ここに提案アイテムが表示されます。</p></div>
            </div>
          </div>
        </div>
      </div></div></div>

  <div class="modal fade" id="aiRegisterModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">AIでアイテム情報の下書きを作成</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <p>アイテムの写真や、素材・洗濯表示などが書かれたタグの画像をアップロードしてください。（複数選択可）</p>
          <div class="custom-file">
            <input type="file" class="custom-file-input" id="itemImageInput" multiple accept="image/*">
            <label class="custom-file-label" for="itemImageInput" data-browse="ファイルを選択">画像を選択...</label>
          </div>
          <div id="imagePreviewContainer">
            <p class="text-muted">ここに選択した画像のプレビューが表示されます。</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
          <button type="button" id="analyzeImagesBtn" class="btn btn-danger" onclick="analyzeImages()" disabled>この画像で解析する</button>
        </div>
      </div></div></div>
      
  <div class="modal fade" id="aiConsultModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">AI相談室</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
    <div class="modal-body d-flex flex-column">
      <div id="aiChatHistory" class="flex-grow-1"><p class="text-muted">AIスタイリストにファッションに関する相談をしてみましょう！</p></div>
      <div id="aiConsultImagePreview"></div>
    </div>
    <div class="modal-footer">
      <div class="ai-consult-footer w-100">
        <input type="file" id="aiConsultImageInput" multiple accept="image/*" style="display: none;">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('aiConsultImageInput').click();">
          <i class="fas fa-paperclip"></i>
        </button>
        <textarea id="aiConsultInput" class="form-control" rows="1" placeholder="例：この中で一番着回しがきくのは？"></textarea>
        <button type="button" id="aiConsultSendBtn" class="btn btn-warning" onclick="handleAiConsultSend()">送信</button>
      </div>
    </div>
  </div></div></div>

  <!-- ★改善: AI提案ボタンを追加 -->
  <div class="modal fade" id="itemDetailModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">アイテム詳細</h5>
      <div>
        <button type="button" id="aiSuggestFromDetailBtn" class="btn btn-danger btn-sm mr-2">
          <i class="fas fa-magic"></i> AIコーデ提案
        </button>
        <button type="button" class="close" data-dismiss="modal" style="font-size: 1.5rem; line-height: 1;">
          <span>&times;</span>
        </button>
      </div>
    </div>
    <div class="modal-body" id="itemDetailContent">
      <!-- Content populated by JS -->
    </div>
  </div></div></div>

  <div class="modal fade" id="calendarDetailModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="calendarDetailTitle"></h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <h6>この日に着たアイテム</h6>
          <div id="calendarDetailItemList"></div>
        </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-primary" id="addItemToDateBtn">+ この日にアイテムを追加</button>
          <div>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
            <button type="button" class="btn btn-info" id="saveCoordFromCalendarBtn" onclick="handleSaveCoordFromCalendar()">このコーデを保存</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- External Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
  <?!= include('javascript'); ?>

</body>
</html>
