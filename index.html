<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Digital Closet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- External Libraries -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  
  <?!= include('stylesheet'); ?>
</head>
<body>

  <div id="loading" style="display: none;"><div class="spinner-border text-dark" role="status"><span class="sr-only">Loading...</span></div></div>

  <div class="main-container">
    <header class="header">
      <h1><i class="fas fa-tshirt mr-2"></i>Digital Closet</h1>
      <div class="header-actions">
        <button class="btn btn-warning" onclick="openAiConsultModal()"><i class="fas fa-comments mr-1"></i> AIに相談</button>
        <button class="btn btn-danger" onclick="openStyleModal()"><i class="fas fa-magic mr-1"></i> AIスタイリスト</button>
        <button class="btn btn-info" onclick="openCoordModal()"><i class="fas fa-layer-group mr-1"></i> コーデ作成</button>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="openItemModal()"><i class="fas fa-plus mr-1"></i> 新規アイテム</button>
          <button class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown"></button>
          <div class="dropdown-menu dropdown-menu-right">
            <a class="dropdown-item" href="#" onclick="openAiRegisterModal(event)">AIで下書きを作成</a>
          </div>
        </div>
      </div>
    </header>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item"><a class="nav-link active" id="closet-tab" data-toggle="tab" href="#closet" role="tab"><i class="fas fa-door-open mr-1 d-none d-sm-inline"></i>Closet</a></li>
      <li class="nav-item"><a class="nav-link" id="dashboard-tab" data-toggle="tab" href="#dashboard" role="tab"><i class="fas fa-chart-pie mr-1 d-none d-sm-inline"></i>Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" id="calendar-tab" data-toggle="tab" href="#calendar" role="tab"><i class="fas fa-calendar-alt mr-1 d-none d-sm-inline"></i>Calendar</a></li>
      <li class="nav-item"><a class="nav-link" id="disposed-tab" data-toggle="tab" href="#disposed" role="tab"><i class="fas fa-trash-alt mr-1 d-none d-sm-inline"></i>廃棄済み</a></li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <!-- Closet Tab -->
      <div class="tab-pane fade show active" id="closet" role="tabpanel">
        <div class="controls mt-4 mb-4">
          <div class="form-row align-items-center">
            <div class="form-group col-12"><input type="text" id="searchInput" class="form-control" placeholder="キーワード検索..."></div>
            <div class="form-group col-md-3 col-6"><select id="categoryFilter" class="form-control"></select></div>
            <div class="form-group col-md-3 col-6"><select id="colorFilter" class="form-control"></select></div>
            <div class="form-group col-md-3 col-6"><select id="seasonFilter" class="form-control"><option value="">シーズン</option><option value="春">春</option><option value="夏">夏</option><option value="秋">秋</option><option value="冬">冬</option></select></div>
            <div class="form-group col-md-3 col-6"><select id="sortOrder" class="form-control"></select></div>
          </div>
           <div class="d-flex justify-content-between align-items-center mt-3 px-2">
               <div class="btn-group btn-group-toggle" data-toggle="buttons">
                   <label class="btn btn-outline-secondary active"><input type="radio" name="view" id="cardView" autocomplete="off" checked> <i class="fas fa-th-large"></i></label>
                   <label class="btn btn-outline-secondary"><input type="radio" name="view" id="listView" autocomplete="off"> <i class="fas fa-bars"></i></label>
               </div>
                <div class="text-secondary"><span id="itemCount">0</span> 件</div>
           </div>
        </div>
        <div id="itemsGrid" class="row"></div>
      </div>
      
      <!-- Dashboard Tab -->
      <div class="tab-pane fade" id="dashboard" role="tabpanel">
        <div class="dashboard-grid mt-4">
            <div class="chart-container" id="statsSummary" style="grid-column: 1 / -1;"></div>
            <div class="chart-container"><h5><i class="fas fa-trophy mr-2 text-warning"></i>着用回数 Top 10</h5><ul id="wearRank" class="rank-list"></ul></div>
            <div class="chart-container">
                <h5><i class="fas fa-ghost mr-2 text-info"></i>ご無沙汰アイテム Top 5</h5>
                <select id="unwornSortOrder" class="form-control form-control-sm mb-2">
                    <option value="last_wear_asc">最後に着てから最も日数が経っている順</option>
                    <option value="wear_count_asc">着用回数が少ない順</option>
                </select>
                <ul id="unwornRank" class="rank-list"></ul>
            </div>
            <div class="chart-container"><h5><i class="fas fa-tags mr-2 text-success"></i>ブランド別 投資額 Top 10</h5><ul id="brandRank" class="rank-list"></ul></div>
            <div class="chart-container"> <canvas id="categoryChart"></canvas> </div>
            <div class="chart-container"> <canvas id="colorChart"></canvas> </div>
            <div class="chart-container" style="grid-column: 1 / -1;"> <canvas id="yearlyInvestmentChart"></canvas> </div>
            <div class="chart-container" style="grid-column: 1 / -1;">
              <div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mb-2">
                  <h5 class="mb-2 mb-sm-0"><i class="fas fa-images mr-2 text-primary"></i>保存したコーデ</h5>
                  <select id="coordFilterItem" class="form-control" style="width: auto; max-width: 250px;"></select>
              </div>
              <div id="saved-coords" class="rank-list"></div>
            </div>
        </div>
      </div>

      <!-- Calendar Tab -->
      <div class="tab-pane fade" id="calendar" role="tabpanel">
          <div id="calendar-container" class="mt-4">
              <div id="calendar-header">
                  <button id="prev-month-btn" class="btn btn-outline-secondary">&lt;</button>
                  <h3 id="month-year-display"></h3>
                  <button id="next-month-btn" class="btn btn-outline-secondary">&gt;</button>
              </div>
              <div id="calendar-grid"></div>
          </div>
      </div>

      <!-- Disposed Tab -->
      <div class="tab-pane fade" id="disposed" role="tabpanel">
        <div class="mt-4 table-responsive-sm">
          <div id="disposedItemsGrid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="itemModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title" id="modalTitle">アイテム情報</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
    <div class="modal-body">
      <input type="hidden" id="itemId">
      <div class="form-group"><label>名前:</label><input type="text" id="itemName" class="form-control" required></div>
      <div class="form-group">
        <label>画像:</label>
        <div>
          <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
          <input type="hidden" id="itemImageUrl">
          <button type="button" class="btn btn-outline-secondary" id="imageUploadBtn">
            <i class="fas fa-paperclip"></i> 画像を選択
          </button>
          <div id="imageUploadPreviewContainer" class="mt-2">
            <img id="imageUploadPreview" src="" style="max-width: 150px; max-height: 150px; display: none; border-radius: 8px;">
          </div>
        </div>
      </div>
      <div class="form-group"><label>種類:</label><select id="itemCategory" class="form-control" required></select></div>
      <div class="form-group"><label>色:</label><select id="itemColor" class="form-control" required></select></div>
      <div class="form-group"><label>ブランド:</label><input type="text" id="itemBrand" class="form-control"></div>
      <div class="form-group"><label>価格:</label><input type="number" id="itemPrice" class="form-control"></div>
      <div class="form-group"><label>購入年:</label><input type="number" id="itemPurchaseYear" class="form-control"></div>
      <div class="form-group"><label>着用シーズン:</label><div id="seasonCheckboxes">
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="seasonSpring" value="春"><label class="form-check-label" for="seasonSpring">春</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="seasonSummer" value="夏"><label class="form-check-label" for="seasonSummer">夏</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="seasonAutumn" value="秋"><label class="form-check-label" for="seasonAutumn">秋</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="seasonWinter" value="冬"><label class="form-check-label" for="seasonWinter">冬</label></div>
      </div></div>
      <div class="form-group"><label>フォーマル度:</label><select id="formality" class="form-control"><option value="1">1 : カジュアル</option><option value="2">2 : ややカジュアル</option><option value="3" selected>3 : 中間</option><option value="4">4 : ややフォーマル</option><option value="5">5 : フォーマル</option></select></div>
      <div class="form-group"><label>素材:</label><input type="text" id="itemMaterial" class="form-control"></div>
      <div class="form-group"><label>柄:</label><input type="text" id="itemPattern" class="form-control"></div>
      <div class="form-group"><label>メモ:</label><textarea id="itemMemo" class="form-control" rows="3"></textarea></div>
    </div>
    <div class="modal-footer justify-content-between">
      <button type="button" id="aiUpdateBtn" class="btn btn-outline-danger" onclick="initiateAiUpdate()"><i class="fas fa-robot mr-1"></i> AIで画像から更新</button>
      <div>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button>
        <button type="button" id="saveItemBtn" class="btn btn-primary" onclick="saveItem()">保存する</button>
      </div>
    </div>
  </div></div></div>

  <div class="modal fade" id="coordModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">コーディネート作成</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
    <div class="modal-body"><p>アイテムを選択してください</p><div id="coord-item-list"></div></div>
    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button><button type="button" id="saveCoordBtn" class="btn btn-info" onclick="saveCoordinate()">このコーデを保存</button></div>
  </div></div></div>

  <div class="modal fade" id="styleModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">AI Stylist</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
        <div class="modal-body">
          <div class="row h-100">
            <div class="col-md-5 d-flex flex-column">
              <h6>1. 基準にするアイテムを選んでください</h6>
              <div id="style-base-item-list"></div>
            </div>
            <div class="col-md-7 d-flex flex-column">
              <h6>2. AIへの要望（任意）</h6>
              <textarea id="styleRequest" class="form-control mb-3" rows="2" placeholder="例：公園に行くのでカジュアルに、寒くないように、デートに着ていきたい 等"></textarea>
              <h6 class="mt-2">3. AIからの提案</h6>
              <div id="style-suggestion-list" class="flex-grow-1"><p class="text-muted">ここに提案アイテムが表示されます。</p></div>
            </div>
          </div>
        </div>
      </div></div></div>

  <div class="modal fade" id="aiRegisterModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">AIでアイテム情報の下書きを作成</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <p>アイテムの写真や、素材・洗濯表示などが書かれたタグの画像をアップロードしてください。（複数選択可）</p>
          <div class="custom-file">
            <input type="file" class="custom-file-input" id="itemImageInput" multiple accept="image/*">
            <label class="custom-file-label" for="itemImageInput" data-browse="ファイルを選択">画像を選択...</label>
          </div>
          <div id="imagePreviewContainer">
            <p class="text-muted">ここに選択した画像のプレビューが表示されます。</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
          <button type="button" id="analyzeImagesBtn" class="btn btn-danger" onclick="analyzeImages()" disabled>この画像で解析する</button>
        </div>
      </div></div></div>
      
  <div class="modal fade" id="aiConsultModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">AI相談室</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
    <div class="modal-body d-flex flex-column">
      <div id="aiChatHistory" class="flex-grow-1"><p class="text-muted">AIスタイリストにファッションに関する相談をしてみましょう！</p></div>
      <div id="aiConsultImagePreview"></div>
    </div>
    <div class="modal-footer">
      <div class="ai-consult-footer w-100">
        <input type="file" id="aiConsultImageInput" multiple accept="image/*" style="display: none;">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('aiConsultImageInput').click();">
          <i class="fas fa-paperclip"></i>
        </button>
        <textarea id="aiConsultInput" class="form-control" rows="1" placeholder="例：この中で一番着回しがきくのは？"></textarea>
        <button type="button" id="aiConsultSendBtn" class="btn btn-warning" onclick="handleAiConsultSend()">送信</button>
      </div>
    </div>
  </div></div></div>

  <div class="modal fade" id="itemDetailModal" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">アイテム詳細</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
    <div class="modal-body" id="itemDetailContent">
    </div>
  </div></div></div>

  <div class="modal fade" id="calendarDayModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="calendarDayModalTitle"></h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
      <div class="modal-body" id="calendarDayModalBody"></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">閉じる</button><button type="button" class="btn btn-info" id="saveCoordFromCalendarBtn">このコーデを保存</button></div>
  </div></div></div>

  <!-- External Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
  <?!= include('javascript'); ?>

</body>
</html>
