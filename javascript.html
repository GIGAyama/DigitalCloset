<script>
  'use strict';
  //----------------------------------------------------------------
  // グローバル変数
  //----------------------------------------------------------------
  let allItems = [], disposedItems = [], masterData = {}, charts = {}, selectedCoordItemIds = [], imageFiles = [];
  let itemToUpdateByAi = null;
  let dashboardDataCache = null;
  let editingCoordId = null; 
  let consultationImageFiles = [];
  const G_DRIVE_THUMBNAIL_URL_PREFIX = "https://drive.google.com/thumbnail?id=";
  
  //----------------------------------------------------------------
  // 初期化処理
  //----------------------------------------------------------------
  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener('mouseenter', Swal.stopTimer)
      toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    setupEventListeners();
    initializeApp();
  });
  
  async function initializeApp() { 
    showLoading(true);
    try {
      masterData = await callServerFunction('getOptions');
      populateDropdowns();
      await loadClosetData();
    } catch (error) {
      onFailure(error);
    } finally {
      showLoading(false);
    }
  }

  function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('input', renderItems);
    ['categoryFilter', 'colorFilter', 'seasonFilter', 'sortOrder'].forEach(id => document.getElementById(id).addEventListener('change', renderItems));
    ['cardView', 'listView'].forEach(id => document.getElementById(id).parentNode.addEventListener('click', renderItems));
    $('a[data-toggle="tab"][href="#dashboard"]').on('shown.bs.tab', setupDashboard);
    $('a[data-toggle="tab"][href="#disposed"]').on('shown.bs.tab', loadDisposedItems);
    
    document.getElementById('itemImageInput').addEventListener('change', handleImageSelection);
    
    document.getElementById('imageUploadBtn').addEventListener('click', () => document.getElementById('imageUploadInput').click());
    document.getElementById('imageUploadInput').addEventListener('change', handleImageUpload);

    document.getElementById('aiConsultImageInput').addEventListener('change', handleConsultImageSelection);
    document.getElementById('coordFilterItem').addEventListener('change', () => {
      if (dashboardDataCache) renderSavedCoords(dashboardDataCache.coordinates);
    });
    document.getElementById('aiConsultInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleAiConsultSend();
      }
    });

    // ★新機能: ご無沙汰アイテムのソート順変更イベント
    document.getElementById('neglectedSortOrder').addEventListener('change', loadNeglectedItems);

    setupEventDelegation();
  }

  function setupEventDelegation() {
    document.getElementById('coord-item-list').addEventListener('click', (e) => {
      const targetItem = e.target.closest('.coord-item');
      if (targetItem) {
        toggleCoordItem(targetItem);
      }
    });

    document.getElementById('style-base-item-list').addEventListener('click', (e) => {
      const targetItem = e.target.closest('.style-item');
      if (targetItem) {
        selectBaseItem(targetItem, targetItem.dataset.id);
      }
    });
  }
  
  //----------------------------------------------------------------
  // サーバー通信
  //----------------------------------------------------------------
  function callServerFunction(functionName, payload) {
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(response => {
          if (response && response.error) {
            reject({ message: response.error });
          } else {
            resolve(response);
          }
        })
        .withFailureHandler(reject)
        [functionName](payload);
    });
  }
  
  //----------------------------------------------------------------
  // データ読み込みと表示
  //----------------------------------------------------------------
  async function loadClosetData() {
    showLoading(true);
    try {
      const data = await callServerFunction('getItems');
      allItems = data.map(item => {
        item['価格'] = parseFloat(String(item['価格']).replace(/[^0-9.-]+/g,"")) || 0;
        item['購入年'] = parseInt(item['購入年'], 10) || 0;
        return item;
      });
      renderItems();
      populateAllModalLists();
    } catch (error) {
      onFailure(error);
    } finally {
      showLoading(false);
    }
  }

  function populateAllModalLists() {
    const sortedItems = [...allItems].sort((a, b) => {
      const catA = a['種類番号'] || '';
      const catB = b['種類番号'] || '';
      if (catA < catB) return -1;
      if (catA > catB) return 1;
      return 0;
    });

    const coordListHtml = sortedItems.map(i => {
        const d = getImageUrl(i, 100);
        return `<div class="coord-item" data-id="${i.ID}"><img loading="lazy" src="${d}" alt="${i['名前']}"><p>${i['名前']}</p></div>`;
    }).join("");
    document.getElementById('coord-item-list').innerHTML = coordListHtml;

    const styleListHtml = sortedItems.map(i => {
        const d = getImageUrl(i, 120);
        return `<div class="style-item" data-id="${i.ID}"><img loading="lazy" src="${d}" alt="${i['名前']}"><p>${i['名前']}</p></div>`;
    }).join('');
    document.getElementById('style-base-item-list').innerHTML = styleListHtml;
  }
  
  async function loadDisposedItems() {
      showLoading(true);
      try {
          disposedItems = await callServerFunction('getDisposedItems');
          renderDisposedItems();
      } catch (error) {
          onFailure(error);
      } finally {
          showLoading(false);
      }
  }

  function getFilteredAndSortedItems() {
    const keyword = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    const color = document.getElementById('colorFilter').value;
    const season = document.getElementById('seasonFilter').value;
    const sortOrder = document.getElementById('sortOrder').value;
    
    let filtered = allItems.filter(item => {
      const matchKeyword = !keyword || (item['名前'] && item['名前'].toLowerCase().includes(keyword)) || (item['ブランド'] && item['ブランド'].toLowerCase().includes(keyword)) || (item['メモ'] && item['メモ'].toLowerCase().includes(keyword));
      const matchCategory = !category || item['種類番号'] == category;
      const matchColor = !color || item['色番号'] == color;
      const matchSeason = !season || (item['着用シーズン'] && item['着用シーズン'].includes(season));
      return matchKeyword && matchCategory && matchColor && matchSeason;
    });

    const [sortKey, sortDir] = sortOrder.split('_');
    const keyMap = { id: 'ID', price: '価格', year: '購入年' };
    const sortField = keyMap[sortKey];

    return filtered.sort((a, b) => {
      let valA = a[sortField];
      let valB = b[sortField];
      return sortDir === 'asc' ? valA - valB : valB - valA;
    });
  }

  function renderItems() {
    const items = getFilteredAndSortedItems();
    const grid = document.getElementById('itemsGrid');
    const isCardView = document.getElementById('cardView').checked;
    
    grid.className = isCardView ? 'row' : '';
    grid.innerHTML = items.length === 0 
      ? '<p class="col-12 text-muted">アイテムがありません。</p>'
      : (isCardView ? items.map(createItemCard).join('') : createItemTable(items));
      
    document.getElementById('itemCount').textContent = items.length;
  }
  
  function renderDisposedItems() {
      const grid = document.getElementById('disposedItemsGrid');
      grid.innerHTML = disposedItems.length === 0
          ? '<p class="text-muted">廃棄済みのアイテムはありません。</p>'
          : `<div class="table-responsive-sm">${createDisposedItemTable(disposedItems)}</div>`;
  }

  function createItemCard(item) {
    const imageUrl = getImageUrl(item, 400);
    return `<div class="col-6 col-md-4 col-lg-3 mb-4">
              <div class="item-card">
                <img loading="lazy" src="${imageUrl}" alt="${item['名前']}" onerror="this.src='${getImageUrl(null, 400)}'" onclick="openItemDetailModal('${item.ID}')">
                <div class="item-card-body">
                  <h5>${item['名前'] || "名称未設定"}</h5>
                  <p>${item['ブランド'] || "ブランド未設定"}</p>
                  <p class="d-none d-md-block">${item['種類']} / ${item['色']}</p>
                  <p class="d-none d-md-block">¥${item['価格'].toLocaleString()}</p>
                </div>
                <div>
                  <button class="btn btn-sm btn-block btn-success mb-2" onclick="handleLogWear('${item.ID}')">今日着た！</button>
                  <div class="item-card-footer">
                    <button class="btn btn-sm btn-outline-primary" onclick="openItemModal('${item.ID}')">編集</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="handleDeleteItem('${item.ID}')">廃棄</button>
                  </div>
                </div>
              </div>
            </div>`;
  }

  function createItemTable(items) {
    const rows = items.map(item => {
      const imageUrl = getImageUrl(item, 100);
      return `<tr>
        <td>${item.ID}</td>
        <td><img loading="lazy" src="${imageUrl}" class="item-thumb" alt="${item['名前']}" onclick="openItemDetailModal('${item.ID}')" style="cursor: pointer;"></td>
        <td>${item['名前'] || ""}</td>
        <td>${item['ブランド'] || ""}</td>
        <td>${item['種類'] || ""}</td>
        <td>¥${item['価格'].toLocaleString()}</td>
        <td>
          <div class="btn-group">
            <button class="btn btn-sm btn-success" onclick="handleLogWear('${item.ID}')">着用</button>
            <button class="btn btn-sm btn-outline-primary" onclick="openItemModal('${item.ID}')">編集</button>
            <button class="btn btn-sm btn-outline-danger" onclick="handleDeleteItem('${item.ID}')">廃棄</button>
          </div>
        </td>
      </tr>`
    }).join("");
    return `<div class="table-responsive-sm"><table class="table table-hover bg-white rounded shadow-sm">
              <thead class="thead-light"><tr><th>ID</th><th></th><th>名前</th><th>ブランド</th><th>種類</th><th>価格</th><th>操作</th></tr></thead>
              <tbody>${rows}</tbody>
            </table></div>`;
  }

  function createDisposedItemTable(items) {
    const rows = items.map(item =>
      `<tr>
        <td>${item.ID}</td>
        <td>${item['名前'] || ""}</td>
        <td>${item['ブランド'] || ""}</td>
        <td>${item['種類'] || ""}</td>
        <td>${item['廃棄年']}</td>
        <td>
          <div class="btn-group">
            <button class="btn btn-sm btn-info" onclick="handleRestoreItem('${item.ID}')">元に戻す</button>
            <button class="btn btn-sm btn-outline-primary" onclick="openItemModal('${item.ID}')">編集</button>
          </div>
        </td>
      </tr>`
    ).join("");
    return `<table class="table table-hover bg-white rounded shadow-sm">
              <thead class="thead-light"><tr><th>ID</th><th>名前</th><th>ブランド</th><th>種類</th><th>廃棄年</th><th>操作</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>`;
  }

  function populateDropdowns() {
    const createOptions = (data) => data.map(d => `<option value="${d.id}">${d.name}</option>`).join("");
    document.getElementById('categoryFilter').innerHTML = '<option value="">種類</option>' + createOptions(masterData.categories);
    document.getElementById('itemCategory').innerHTML = createOptions(masterData.categories);
    document.getElementById('colorFilter').innerHTML = '<option value="">色</option>' + createOptions(masterData.colors);
    document.getElementById('itemColor').innerHTML = createOptions(masterData.colors);
    const sortOptions = [
      { value: "id_desc", text: "登録日 (新しい順)" }, { value: "id_asc", text: "登録日 (古い順)" },
      { value: "price_desc", text: "価格 (高い順)" }, { value: "price_asc", text: "価格 (安い順)" },
      { value: "year_desc", text: "購入年 (新しい順)" }, { value: "year_asc", text: "購入年 (古い順)" },
    ];
    document.getElementById('sortOrder').innerHTML = sortOptions.map(o => `<option value="${o.value}">${o.text}</option>`).join('');
  }
  
  //----------------------------------------------------------------
  // アイテム操作 (CRUD & Image Upload)
  //----------------------------------------------------------------
  function openItemModal(id = null, prefillData = null) {
    const previewImg = document.getElementById('imageUploadPreview');
    previewImg.style.display = 'none';
    previewImg.src = '';
    document.getElementById('imageUploadInput').value = '';

    const isNew = id === null && !prefillData;
    let item = {};
    if (id) {
        item = [...allItems, ...disposedItems].find(i => i.ID == id);
        if (!item) { onFailure({message: '指定されたアイテムが見つかりません。'}); return; }
    } else if (prefillData) {
        item = prefillData;
        if (item['種類']) {
            const category = masterData.categories.find(c => c.name === item['種類']);
            if (category) item['種類番号'] = category.id;
        }
        if (item['色']) {
            const color = masterData.colors.find(c => c.name === item['色']);
            if (color) item['色番号'] = color.id;
        }
    }
    document.getElementById('modalTitle').textContent = isNew ? '新規アイテム登録' : 'アイテムの編集';
    document.getElementById('itemId').value = item.ID || '';
    document.getElementById('itemName').value = item['名前'] || '';
    document.getElementById('itemImageUrl').value = item['画像URL'] || '';
    
    if (item['画像URL']) {
      previewImg.src = getImageUrl(item, 200);
      previewImg.style.display = 'block';
    }

    document.getElementById('itemCategory').value = item['種類番号'] || '';
    document.getElementById('itemColor').value = item['色番号'] || '';
    document.getElementById('itemBrand').value = item['ブランド'] || '';
    document.getElementById('itemPrice').value = item['価格'] || '';
    document.getElementById('itemPurchaseYear').value = item['購入年'] || new Date().getFullYear();
    document.querySelectorAll('#seasonCheckboxes input').forEach(cb => cb.checked = false);
    if (item['着用シーズン']) {
        const seasons = Array.isArray(item['着用シーズン']) ? item['着用シーズン'] : String(item['着用シーズン']).split(',');
        seasons.forEach(s => {
            const checkbox = document.querySelector(`#seasonCheckboxes input[value="${s.trim()}"]`);
            if (checkbox) checkbox.checked = true;
        });
    }
    document.getElementById('formality').value = item['フォーマル度'] || '3';
    document.getElementById('itemMaterial').value = item['素材'] || '';
    document.getElementById('itemPattern').value = item['柄'] || '';
    document.getElementById('itemMemo').value = item['メモ'] || '';
    
    document.getElementById('aiUpdateBtn').style.display = (id || (prefillData && prefillData.ID)) ? 'block' : 'none';
    
    $('#itemModal').modal('show');
  }

  async function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    showLoading(true);
    const btn = document.getElementById('imageUploadBtn');
    btn.disabled = true;

    try {
      const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
      
      const itemId = document.getElementById('itemId').value;
      const result = await callServerFunction('uploadImage', {
        fileData: dataUrl,
        fileName: file.name,
        itemId: itemId
      });

      document.getElementById('itemImageUrl').value = result.fileId;
      if (result.newItemId) {
        document.getElementById('itemId').value = result.newItemId;
      }

      const previewImg = document.getElementById('imageUploadPreview');
      previewImg.src = getImageUrl({ '画像URL': result.fileId }, 200);
      previewImg.style.display = 'block';

      Toast.fire({ icon: 'success', title: '画像をアップロードしました。' });

    } catch (error) {
      onFailure(error);
    } finally {
      showLoading(false);
      btn.disabled = false;
      event.target.value = '';
    }
  }

  async function saveItem() {
    const btn = document.getElementById('saveItemBtn'); 
    btn.disabled = true; 
    btn.textContent = '保存中...';
    
    try {
      const categorySelect = document.getElementById('itemCategory');
      const colorSelect = document.getElementById('itemColor');

      const itemData = {
          id: document.getElementById('itemId').value,
          '名前': document.getElementById('itemName').value,
          '種類': categorySelect.options[categorySelect.selectedIndex].text,
          '色': colorSelect.options[colorSelect.selectedIndex].text,
          'ブランド': document.getElementById('itemBrand').value,
          '価格': document.getElementById('itemPrice').value,
          '購入年': document.getElementById('itemPurchaseYear').value,
          '画像URL': document.getElementById('itemImageUrl').value,
          '着用シーズン': Array.from(document.querySelectorAll('#seasonCheckboxes input:checked')).map(el => el.value).join(','),
          'フォーマル度': document.getElementById('formality').value, '素材': document.getElementById('itemMaterial').value,
          '柄': document.getElementById('itemPattern').value, 'メモ': document.getElementById('itemMemo').value
      };

      if (!itemData.id) {
        const tempResult = await callServerFunction('uploadImage', {});
        itemData.id = tempResult.newItemId;
      }

      const result = await callServerFunction('saveItem', itemData);
      
      Toast.fire({ icon: 'success', title: result.message });
      
      $('#itemModal').modal('hide');
      await Promise.all([loadClosetData(), loadDisposedItems()]);

    } catch (error) {
      onFailure(error);
    } finally {
      btn.disabled = false; 
      btn.textContent = '保存する';
    }
  }

  async function handleDeleteItem(id) { 
    const isConfirmed = await showConfirmationDialog({
      text: "このアイテムを「廃棄済み」にしますか？（後から元に戻せます）",
      confirmButtonText: 'はい、廃棄します'
    });

    if (isConfirmed) {
      showLoading(true);
      try {
        const res = await callServerFunction('deleteItem', id);
        Toast.fire({ icon: 'success', title: res.message });
        await loadClosetData();
      } catch(error) {
        onFailure(error);
      } finally {
        showLoading(false);
      }
    }
  }
  
  async function handleRestoreItem(id) {
      const isConfirmed = await showConfirmationDialog({
        text: "このアイテムをクローゼットに戻しますか？",
        icon: 'info',
        confirmButtonText: 'はい、戻します'
      });
      if (isConfirmed) {
          showLoading(true);
          try {
              const res = await callServerFunction('restoreItem', id);
              Toast.fire({ icon: 'success', title: res.message });
              await Promise.all([loadClosetData(), loadDisposedItems()]);
          } catch(error) {
              onFailure(error);
          } finally {
              showLoading(false);
          }
      }
  }

  async function handleLogWear(id) {
      if (id) { 
          showLoading(true);
          try {
              const result = await callServerFunction('logWear', id);
              Toast.fire({ icon: 'success', title: result.message });
          } catch (error) {
              onFailure(error);
          } finally {
              showLoading(false);
          }
      } 
  }
  
  //----------------------------------------------------------------
  // コーデ操作
  //----------------------------------------------------------------
  function openCoordModal(idsToSelect = []) {
      if (idsToSelect.length === 0) {
          editingCoordId = null;
      }
      
      document.querySelectorAll('#coord-item-list .coord-item').forEach(el => {
          el.classList.toggle('selected', idsToSelect.includes(el.dataset.id));
      });

      selectedCoordItemIds = [...idsToSelect];
      $('#coordModal').modal('show');
  }

  function toggleCoordItem(element) {
      const id = element.dataset.id;
      element.classList.toggle('selected');
      
      const index = selectedCoordItemIds.indexOf(id);
      if (index > -1) {
          selectedCoordItemIds.splice(index, 1);
      } else {
          selectedCoordItemIds.push(id);
      }
  }

  async function saveCoordinate() {
      if (selectedCoordItemIds.length < 2) {
          Swal.fire('エラー', 'アイテムを2つ以上選択してください。', 'error');
          return;
      }
      const btn = document.getElementById('saveCoordBtn');
      if (btn) { btn.disabled = true; btn.textContent = '保存中...'; }
      
      try {
          showLoading(true);
          const payload = {
              itemIds: selectedCoordItemIds,
              rating: 0, 
              reason: '',
              coordId: editingCoordId 
          };
          const result = await callServerFunction('saveCoordinate', payload);
          
          Toast.fire({ icon: result.status === 'success' ? 'success' : 'error', title: result.message });

          if (result.status === 'success') {
              $('#coordModal').modal('hide');
              await setupDashboard();
          }
      } catch (error) {
          onFailure(error);
      } finally {
          if (btn) { btn.disabled = false; btn.textContent = 'このコーデを保存'; }
          showLoading(false);
          editingCoordId = null;
      }
  }

  //----------------------------------------------------------------
  // AI スタイリスト
  //----------------------------------------------------------------
  function openStyleModal() {
      document.querySelectorAll('#style-base-item-list .style-item.selected').forEach(el => {
          el.classList.remove('selected');
      });
      document.getElementById('style-suggestion-list').innerHTML = '<p class="text-muted">ここに提案アイテムが表示されます。</p>';
      document.getElementById('styleRequest').value = '';
      $('#styleModal').modal('show');
  }

  async function selectBaseItem(element, id) {
      document.querySelectorAll('.style-item.selected').forEach(el => el.classList.remove('selected'));
      element.classList.add('selected');
      document.getElementById('style-suggestion-list').innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-danger" role="status"><span class="sr-only">...</span></div></div>';
      
      try {
          const request = document.getElementById('styleRequest').value;
          const response = await callServerFunction('getStyleSuggestion', { baseItemId: id, customRequest: request });
          const suggestions = response.suggestions;
          document.getElementById('style-suggestion-list').innerHTML = (!suggestions || suggestions.length === 0) ? '<p class="text-muted">良い提案が見つかりませんでした。</p>' : suggestions.map(coord => {
              const itemImages = coord.items.map(i => {
                      const d = getImageUrl(i, 100);
                      return `<img loading="lazy" src="${d}" alt="${i['名前']}">`
                  }).join(""),
                  itemIds = coord.items.map(i => i.ID),
                  safeReason = coord.reason.replace(/'/g, '&apos;');
              return `<div class="card mb-3"><div class="card-body">
                          <p class="card-text"><small class="text-muted">${coord.reason}</small></p>
                          <div class="d-flex align-items-center mb-2">
                            <div class="d-flex flex-grow-1 suggestion-item-images">${itemImages}</div>
                            <button class="btn btn-sm btn-outline-info" data-item-ids='${JSON.stringify(itemIds)}' data-reason='${safeReason}' onclick="saveAiSuggestion(this, 0)">保存</button>
                          </div>
                          <div class="rating-stars">
                            ${[1,2,3,4,5].map(v => `<span class="star" data-item-ids='${JSON.stringify(itemIds)}' data-reason='${safeReason}' onmouseover="rateHover(this.parentElement, true, ${v})" onmouseout="renderSavedCoordRating(this.parentElement, 0)" onclick="saveAiSuggestion(this, ${v})">☆</span>`).join('')}
                          </div>
                        </div></div>`;
          }).join("");
      } catch (error) {
          onFailure(error);
          document.getElementById('style-suggestion-list').innerHTML = `<p class="text-danger">エラーが発生しました。</p>`;
      }
  }

  async function saveAiSuggestion(element, rating) {
      const itemIdsString = element.dataset.itemIds;
      const reason = element.dataset.reason || '';
      if (!itemIdsString) { onFailure({ message: 'アイテムIDが見つかりませんでした。' }); return; }
      const itemIds = JSON.parse(itemIdsString);
      const container = element.closest('.card-body');
      container.querySelectorAll('button, .star').forEach(el => {
          el.style.pointerEvents = 'none';
          el.style.opacity = '0.5';
      });

      try {
          const result = await callServerFunction('saveCoordinate', { itemIds, rating, reason });
          Toast.fire({ icon: result.status === 'success' ? 'success' : 'error', title: result.message });

          if (result.status === 'success') {
              container.querySelector('button').style.display = 'none';
              container.querySelector('.rating-stars').innerHTML = '<span class="text-success">評価を保存しました！</span>';
              await setupDashboard();
          }
      } catch(error) {
           onFailure(error);
      }
  }
  
  function rateHover(starContainer, isHovering, rating) {
      const stars = starContainer.querySelectorAll('.star');
      if (isHovering) {
          stars.forEach((star, index) => {
              star.classList.toggle('selected', index < rating);
          });
      } else {
          const currentRating = starContainer.dataset.currentRating;
          renderSavedCoordRating(starContainer, currentRating);
      }
  }

  //----------------------------------------------------------------
  // AI アイテム登録
  //----------------------------------------------------------------
  function initiateAiUpdate() {
    itemToUpdateByAi = document.getElementById('itemId').value;
    if (!itemToUpdateByAi) { 
        Swal.fire('エラー', '更新対象のアイテムIDが見つかりません。', 'error');
        return;
    }
    $('#itemModal').modal('hide');
    openAiRegisterModal(event);
  }

  function openAiRegisterModal(event) {
    if (event) event.preventDefault();
    const analyzeBtn = document.getElementById('analyzeImagesBtn');
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = 'この画像で解析する';
    document.getElementById('itemImageInput').value = '';
    document.querySelector('.custom-file-label').textContent = '画像を選択...';
    document.getElementById('imagePreviewContainer').innerHTML = '<p class="text-muted">ここに選択した画像のプレビューが表示されます。</p>';
    imageFiles = [];
    $('#aiRegisterModal').modal('show');
  }

  function handleImageSelection(event) {
      const files = event.target.files;
      if (!files.length) return;
      const fileLabel = document.querySelector('.custom-file-label');
      fileLabel.textContent = `${files.length}個のファイルを選択中`;
      const previewContainer = document.getElementById('imagePreviewContainer');
      previewContainer.innerHTML = '';
      imageFiles = Array.from(files);
      imageFiles.forEach(file => {
          const reader = new FileReader();
          reader.onload = (e) => {
              const wrapper = document.createElement('div');
              wrapper.className = 'preview-image-wrapper';
              const img = document.createElement('img');
              img.src = e.target.result;
              img.className = 'preview-image';
              wrapper.appendChild(img);
              previewContainer.appendChild(wrapper);
          };
          reader.readAsDataURL(file);
      });
      document.getElementById('analyzeImagesBtn').disabled = false;
  }

  async function analyzeImages() {
    if (imageFiles.length === 0) { 
        Swal.fire('情報', '画像が選択されていません。', 'info');
        return;
    }
    const analyzeBtn = document.getElementById('analyzeImagesBtn');
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> 解析中...`;
    showLoading(true);

    try {
      const imagesData = await Promise.all(imageFiles.map(fileToB64));
      const response = await callServerFunction('analyzeImagesWithAI', imagesData);
      $('#aiRegisterModal').modal('hide');
      if (itemToUpdateByAi) {
        response.data.ID = itemToUpdateByAi;
        openItemModal(itemToUpdateByAi, response.data);
        itemToUpdateByAi = null;
      } else {
        openItemModal(null, response.data); 
      }
    } catch (error) {
      onFailure({ message: '画像の処理中にエラーが発生しました: ' + error.message });
    } finally {
      showLoading(false);
    }
  }
  
  //----------------------------------------------------------------
  // AI 相談室
  //----------------------------------------------------------------
  function openAiConsultModal() {
      const chatHistory = document.getElementById('aiChatHistory');
      if (chatHistory.querySelector('.text-muted')) {
          chatHistory.innerHTML = '<p class="text-muted">AIスタイリストにファッションに関する相談をしてみましょう！</p>';
      }
      document.getElementById('aiConsultInput').value = '';
      consultationImageFiles = [];
      renderConsultImagePreviews();
      $('#aiConsultModal').modal('show');
  }

  function handleConsultImageSelection(event) {
      const files = Array.from(event.target.files);
      consultationImageFiles.push(...files);
      renderConsultImagePreviews();
      event.target.value = '';
  }

  function renderConsultImagePreviews() {
      const previewContainer = document.getElementById('aiConsultImagePreview');
      previewContainer.innerHTML = '';
      consultationImageFiles.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = (e) => {
              const wrapper = document.createElement('div');
              wrapper.className = 'consult-preview-wrapper';
              
              const img = document.createElement('img');
              img.src = e.target.result;
              img.className = 'consult-preview-img';

              const removeBtn = document.createElement('button');
              removeBtn.className = 'consult-preview-remove';
              removeBtn.innerHTML = '&times;';
              removeBtn.onclick = () => {
                  consultationImageFiles.splice(index, 1);
                  renderConsultImagePreviews();
              };

              wrapper.appendChild(img);
              wrapper.appendChild(removeBtn);
              previewContainer.appendChild(wrapper);
          };
          reader.readAsDataURL(file);
      });
  }

  async function handleAiConsultSend() {
      const input = document.getElementById('aiConsultInput');
      const question = input.value.trim();
      if (!question && consultationImageFiles.length === 0) return;

      const chatHistory = document.getElementById('aiChatHistory');
      if (chatHistory.querySelector('.text-muted')) chatHistory.innerHTML = '';
      
      let userMessageHtml = `<div class="chat-message chat-user d-flex flex-column align-items-end">`;
      if (consultationImageFiles.length > 0) {
          const imagePreviews = consultationImageFiles.map(file => `<img src="${URL.createObjectURL(file)}">`).join('');
          userMessageHtml += `<div class="chat-user-images">${imagePreviews}</div>`;
      }
      if (question) {
          userMessageHtml += `<p>${question}</p>`;
      }
      userMessageHtml += `</div>`;
      chatHistory.innerHTML += userMessageHtml;

      input.value = '';
      chatHistory.scrollTop = chatHistory.scrollHeight;

      const thinkingBubble = document.createElement('div');
      thinkingBubble.className = 'chat-message chat-ai';
      thinkingBubble.id = 'ai-thinking';
      thinkingBubble.innerHTML = `<p><span class="spinner-border spinner-border-sm"></span> 考え中...</p>`;
      chatHistory.appendChild(thinkingBubble);
      chatHistory.scrollTop = chatHistory.scrollHeight;
      
      const sendBtn = document.getElementById('aiConsultSendBtn');
      sendBtn.disabled = true;
      
      try {
          let response;
          if (consultationImageFiles.length > 0) {
              const imagesData = await Promise.all(consultationImageFiles.map(fileToB64));
              response = await callServerFunction('getAiConsultationWithImages', { userQuestion: question, images: imagesData });
          } else {
              response = await callServerFunction('getAiConsultation', question);
          }
          
          let htmlAnswer = response.answer
              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
              .replace(/^- (.*$)/gm, '・$1')
              .replace(/\n/g, '<br>');
          thinkingBubble.innerHTML = `<p>${htmlAnswer}</p>`;
          
          consultationImageFiles = [];
          renderConsultImagePreviews();

      } catch (error) {
          thinkingBubble.innerHTML = `<p class="text-danger">エラー: ${error.message}</p>`;
      } finally {
           chatHistory.scrollTop = chatHistory.scrollHeight;
           sendBtn.disabled = false;
      }
  }
  
  //----------------------------------------------------------------
  // ダッシュボード & 詳細画面
  //----------------------------------------------------------------
  async function setupDashboard() {
      showLoading(true);
      try {
          const data = await callServerFunction('getDashboardData');
          renderDashboard(data);
          loadNeglectedItems(); // ★新機能: ご無沙汰アイテムを初期表示
      } catch(error) {
          onFailure(error);
      } finally {
          showLoading(false);
      }
  }

  function renderStatsSummary(stats) {
      const container = document.getElementById('statsSummary');
      container.innerHTML = `
          <div class="stat-item">
              <h2>${stats.totalItems}</h2>
              <p>Items</p>
          </div>
          <div class="stat-item">
              <h2>¥${stats.totalCost.toLocaleString()}</h2>
              <p>Total Value</p>
          </div>`;
  }

  function renderDashboard(data) {
      dashboardDataCache = data;
      Object.values(charts).forEach(c => c.destroy());
      charts = {};
      renderStatsSummary(data.stats);
      renderWearRank(data.wearRank);
      renderBrandRank(data.brandData);
      populateCoordFilter(data.coordinates);
      renderSavedCoords(data.coordinates);
      createCategoryChart(data.categoryData);
      createColorChart(data.colorData, data.colorMaster);
      createYearlyInvestmentChart(data.purchaseData);
  }
  
  async function openItemDetailModal(itemId) {
    showLoading(true);
    try {
      const data = await callServerFunction('getItemDetails', itemId);
      const contentDiv = document.getElementById('itemDetailContent');
      contentDiv.innerHTML = buildItemDetailHtml(data);
      $('#itemDetailModal').modal('show');
    } catch (error) {
      onFailure(error);
    } finally {
      showLoading(false);
    }
  }

  // ★新機能: アイテム詳細画面のHTMLを生成
  function buildItemDetailHtml(data) {
    const { item, coordinates, wearStats, costPerWear } = data;
    const imageUrl = getImageUrl(item, 400);

    const headerHtml = `
      <div class="item-detail-grid">
        <div class="item-detail-img-container">
          <img loading="lazy" src="${imageUrl}" alt="${item['名前']}" onerror="this.src='${getImageUrl(null, 400)}'">
        </div>
        <div class="item-detail-info-container">
          <h3>${item['名前']}</h3>
          <dl id="itemDetailInfo">
            <dt>ブランド</dt><dd>${item['ブランド'] || '-'}</dd>
            <dt>種類</dt><dd>${item['種類'] || '-'}</dd>
            <dt>色</dt><dd>${item['色'] || '-'}</dd>
            <dt>価格</dt><dd>¥${(item['価格'] || 0).toLocaleString()}</dd>
            <dt>購入年</dt><dd>${item['購入年'] || '-'}</dd>
            <dt>シーズン</dt><dd>${item['着用シーズン'] || '-'}</dd>
            <dt>フォーマル度</dt><dd>${item['フォーマル度'] || '-'}</dd>
            <dt>メモ</dt><dd>${item['メモ'] || '-'}</dd>
          </dl>
        </div>
        <div class="item-detail-stats-container">
          <div class="stat-box">
            <div class="stat-value">${wearStats.total} <small>回</small></div>
            <div class="stat-label">総着用回数</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">¥${costPerWear > 0 ? costPerWear.toLocaleString() : '-'}</div>
            <div class="stat-label">コストパフォーマンス</div>
          </div>
        </div>
        <div class="item-detail-wear-history">
          <h5>着用履歴</h5>
          <div class="wear-history-grid">
            <div>
              <h6>年度別</h6>
              ${Object.keys(wearStats.byYear).length > 0
                ? `<ul class="wear-history-list">${Object.entries(wearStats.byYear).sort((a,b) => b[0] - a[0]).map(([year, count]) => `<li>${year}年: <strong>${count}</strong>回</li>`).join('')}</ul>`
                : '<p class="text-muted small">記録なし</p>'
              }
            </div>
            <div>
              <h6>最近の着用</h6>
              ${wearStats.history.length > 0
                ? `<ul class="wear-history-list">${wearStats.history.map(date => `<li>${date}</li>`).join('')}</ul>`
                : '<p class="text-muted small">記録なし</p>'
              }
            </div>
          </div>
        </div>
      </div>
    `;

    const coordsHtml = `
      <div id="itemDetailCoords">
        <h5 class="mt-4">このアイテムを使ったコーデ</h5>
        <ul class="rank-list">
          ${coordinates.length > 0 ? coordinates.map(coord => renderCoordItem(coord, item.ID)).join('') : '<li class="text-muted">関連するコーデはありません。</li>'}
        </ul>
      </div>
    `;
    return headerHtml + coordsHtml;
  }

  function renderCoordItem(coord, mainItemId) {
    const itemImages = coord.items.map(i => {
        if (!i) return '';
        const imgUrl = getImageUrl(i, 100);
        return `<img loading="lazy" src="${imgUrl}" alt="${i['名前']}" title="${i['名前']}">`;
    }).join("");

    const ratingOnClick = mainItemId 
      ? `updateRatingFromDetail('${coord.id}', v, '${mainItemId}')`
      : `updateRating('${coord.id}', v)`;

    const ratingStars = [1, 2, 3, 4, 5].map(v =>
        `<span class="star ${v <= coord.rating ? 'selected' : ''}" onmouseover="rateHover(this.parentElement, true, ${v})" onmouseout="renderSavedCoordRating(this.parentElement, ${coord.rating})" onclick="${ratingOnClick.replace('v', v)}">★</span>`
    ).join('');
    
    const actionsHtml = mainItemId 
      ? `<div class="saved-coord-actions">
           <button class="btn btn-sm btn-success" onclick='handleLogCoordinateWear(${JSON.stringify(coord.itemIds)})'>着用</button>
           <button class="btn btn-sm btn-outline-primary" onclick='handleEditCoordinateFromDetail(${JSON.stringify(coord.itemIds)}, "${coord.id}")'>編集</button>
           <button class="btn btn-sm btn-outline-danger" onclick="handleDeleteCoordinateFromDetail('${coord.id}', '${mainItemId}')">削除</button>
         </div>`
      : `<div class="saved-coord-actions">
           <button class="btn btn-sm btn-success" onclick='handleLogCoordinateWear(${JSON.stringify(coord.itemIds)})'>着用</button>
           <button class="btn btn-sm btn-outline-primary" onclick='handleEditCoordinate(${JSON.stringify(coord.itemIds)}, "${coord.id}")'>編集</button>
           <button class="btn btn-sm btn-outline-danger" onclick="handleDeleteCoordinate('${coord.id}')">削除</button>
         </div>`;

    const reasonHtml = coord.reason ? `<p class="coord-reason text-muted small"><em>AI: ${coord.reason}</em></p>` : '';

    return `<li class="rank-item">
      <div class="saved-coord-item">
        <div class="saved-coord-main">
          <div class="suggestion-item-images">${itemImages}</div>
          <div class="ml-auto rating-stars" id="${mainItemId ? 'detail-rating-' : 'rating-'}${coord.id}" data-current-rating="${coord.rating}">${ratingStars}</div>
          ${actionsHtml}
        </div>
        ${reasonHtml}
      </div>
    </li>`;
  }

  async function updateRatingFromDetail(coordId, rating, itemId) {
    const starContainer = document.getElementById(`detail-rating-${coordId}`);
    starContainer.style.pointerEvents = 'none';
    try {
      await callServerFunction('updateCoordinateRating', { coordId, rating });
      await openItemDetailModal(itemId);
    } catch(error) {
      onFailure(error);
    }
  }

  function handleEditCoordinateFromDetail(itemIds, coordId) {
    $('#itemDetailModal').modal('hide');
    setTimeout(() => {
      handleEditCoordinate(itemIds, coordId);
    }, 500);
  }

  async function handleDeleteCoordinateFromDetail(coordId, itemId) {
    const isConfirmed = await showConfirmationDialog({
        text: "このコーデを削除しますか？",
        confirmButtonText: 'はい、削除します'
    });
    if (isConfirmed) {
        showLoading(true);
        try {
            const res = await callServerFunction('deleteCoordinate', coordId);
            Toast.fire({ icon: 'success', title: res.message });
            await setupDashboard();
            await openItemDetailModal(itemId);
        } catch(error) {
            onFailure(error);
        } finally {
            showLoading(false);
        }
    }
  }

  function populateCoordFilter(coords) {
      const filter = document.getElementById('coordFilterItem');
      const uniqueItemIds = new Set();
      coords.forEach(coord => {
          coord.items.forEach(item => { if(item) uniqueItemIds.add(item.ID); });
      });

      const itemsForFilter = allItems.filter(item => uniqueItemIds.has(item.ID));

      itemsForFilter.sort((a, b) => {
        const categoryA = a['種類番号'] || 0;
        const categoryB = b['種類番号'] || 0;
        const nameA = a['名前'] || '';
        const nameB = b['名前'] || '';
        if (categoryA < categoryB) return -1;
        if (categoryA > categoryB) return 1;
        if (nameA < nameB) return -1;
        if (nameA > nameB) return 1;
        return 0;
      });

      const options = itemsForFilter
          .map(item => `<option value="${item.ID}">${item['名前']}</option>`)
          .join('');

      filter.innerHTML = '<option value="">すべてのアイテム</option>' + options;
  }

  function renderWearRank(data) {
      const list = document.getElementById('wearRank');
      if (!data || data.length === 0) {
          list.innerHTML = "<li>着用記録がありません。</li>";
          return;
      }
      list.innerHTML = data.map(d => {
          const imgUrl = getImageUrl(d.item, 100);
          return `<li class="rank-item">
                      <img loading="lazy" src="${imgUrl}" alt="${d.item['名前']}">
                      <div class="rank-item-info">
                        <div class="name">${d.item['名前']}</div>
                        <div class="brand">${d.item['ブランド']}</div>
                      </div>
                      <div class="count">${d.count}回</div>
                    </li>`;
      }).join("");
  }

  // ★新機能: ご無沙汰アイテムリストの描画
  async function loadNeglectedItems() {
    const sortType = document.getElementById('neglectedSortOrder').value;
    const list = document.getElementById('neglectedItemsList');
    list.innerHTML = '<li><div class="spinner-border spinner-border-sm" role="status"></div> 読み込み中...</li>';

    try {
      const data = await callServerFunction('getNeglectedItems', sortType);
      renderNeglectedItems(data);
    } catch(error) {
      onFailure(error);
      list.innerHTML = '<li>エラーが発生しました。</li>';
    }
  }

  function renderNeglectedItems(data) {
      const list = document.getElementById('neglectedItemsList');
      if (!data || data.length === 0) {
          list.innerHTML = "<li>対象アイテムはありません。</li>";
          return;
      }
      list.innerHTML = data.map(d => {
          const imgUrl = getImageUrl(d.item, 100);
          return `<li class="rank-item">
                      <img loading="lazy" src="${imgUrl}" alt="${d.item['名前']}" onclick="openItemDetailModal('${d.item.ID}')" style="cursor: pointer;">
                      <div class="rank-item-info">
                        <div class="name">${d.item['名前']}</div>
                        <div class="brand">着用: ${d.wearCount}回</div>
                      </div>
                      <div class="count small">${d.lastWorn}</div>
                    </li>`;
      }).join("");
  }


  function renderBrandRank(data) {
      const list = document.getElementById('brandRank');
      const sortedBrands = Object.entries(data).sort(([, a], [, b]) => b.amount - a.amount).slice(0, 10);
      if (!sortedBrands || sortedBrands.length === 0) {
          list.innerHTML = "<li>データがありません。</li>";
          return;
      }
      list.innerHTML = sortedBrands.map(([name, values]) => `
          <li class="rank-item">
              <div class="rank-item-info">
                  <div class="name">${name}</div>
                  <div class="brand">${values.count} 点</div>
              </div>
              <div class="count">¥${values.amount.toLocaleString()}</div>
          </li>
      `).join("");
  }

  function renderSavedCoords(coords) {
      const container = document.getElementById('saved-coords');
      const filterItemId = document.getElementById('coordFilterItem').value;
      let filteredCoords = coords;
      if (filterItemId) {
          filteredCoords = coords.filter(c => c.items.some(item => item && item.ID == filterItemId));
      }
      if (!filteredCoords || filteredCoords.length === 0) {
          container.innerHTML = '<p class="text-muted">対象のコーデはありません。</p>';
          return;
      }
      container.innerHTML = filteredCoords.map(coord => renderCoordItem(coord, null)).join('');
  }

  function handleEditCoordinate(itemIds, coordId) {
      editingCoordId = coordId;
      openCoordModal(itemIds);
  }
  
  function renderSavedCoordRating(starContainer, rating) {
      const currentRating = starContainer.dataset.currentRating;
      starContainer.querySelectorAll('.star').forEach((star, index) => {
          star.classList.toggle('selected', index < currentRating);
      });
  }

  async function updateRating(coordId, rating) {
      const starContainer = document.getElementById(`rating-${coordId}`);
      starContainer.style.pointerEvents = 'none';
      try {
          await callServerFunction('updateCoordinateRating', { coordId, rating });
          starContainer.dataset.currentRating = rating;
          dashboardDataCache.coordinates.find(c => c.id == coordId).rating = rating;
          renderSavedCoordRating(starContainer, rating);
      } catch(error) {
          onFailure(error);
      } finally {
          starContainer.style.pointerEvents = 'auto';
      }
  }

  async function handleDeleteCoordinate(coordId) {
    const isConfirmed = await showConfirmationDialog({
        text: "このコーデを削除しますか？",
        confirmButtonText: 'はい、削除します'
    });
    if (isConfirmed) {
        showLoading(true);
        try {
            const res = await callServerFunction('deleteCoordinate', coordId);
            Toast.fire({ icon: 'success', title: res.message });
            await setupDashboard();
        } catch(error) {
            onFailure(error);
        } finally {
            showLoading(false);
        }
    }
  }

  async function handleLogCoordinateWear(itemIds) {
    const isConfirmed = await showConfirmationDialog({
      text: `${itemIds.length}点のアイテムをまとめて着用記録しますか？`,
      icon: 'question',
      confirmButtonColor: '#28a745',
      confirmButtonText: 'はい、記録します'
    });
    if (isConfirmed) {
        showLoading(true);
        try {
            const res = await callServerFunction('logCoordinateWear', itemIds);
            Toast.fire({ icon: 'success', title: res.message });
        } catch(error) {
            onFailure(error);
        } finally {
            showLoading(false);
        }
    }
  }
  
  //----------------------------------------------------------------
  // グラフ描画
  //----------------------------------------------------------------
  function createChart(id, type, data, options) {
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id).getContext("2d"), { type, data, options });
  }
  
  function createCategoryChart(d) {
      createChart("categoryChart", "pie", {
          labels: Object.keys(d),
          datasets: [{
              data: Object.values(d),
              backgroundColor: ["#007bff", "#6610f2", "#6f42c1", "#e83e8c", "#dc3545", "#fd7e14", "#ffc107", "#28a745", "#20c997", "#17a2b8", "#4A5568", "#343a40"]
          }]
      }, {
          plugins: {
              title: { display: true, text: "種類別アイテム比率", font: { size: 16 } },
              legend: { position: "right" }
          }
      });
  }

  function createColorChart(data, colorMaster) {
      const labels = Object.keys(data);
      const chartData = Object.values(data);
      const backgroundColors = labels.map(label => {
          const colorInfo = colorMaster.find(c => c.name === label);
          return colorInfo && colorInfo.code ? colorInfo.code : '#cccccc';
      });
      createChart("colorChart", "doughnut", {
          labels: labels,
          datasets: [{ data: chartData, backgroundColor: backgroundColors, borderColor: "#ffffff" }]
      }, {
          plugins: {
              title: { display: true, text: "色別アイテム比率", font: { size: 16 } },
              legend: { position: "right" }
          }
      });
  }

  function createYearlyInvestmentChart(d) {
      const sortedYears = Object.keys(d).sort((a,b) => a - b);
      createChart("yearlyInvestmentChart", "bar", {
          labels: sortedYears,
          datasets: [{
              label: "年間投資額 (円)",
              data: sortedYears.map(year => d[year]),
              backgroundColor: "#4A5568",
          }]
      }, {
          plugins: {
              title: { display: true, text: "購入年別 投資額推移", font: { size: 16 } },
              legend: { display: false }
          },
          scales: { y: { ticks: { callback: i => `¥${i.toLocaleString()}` } } }
      });
  }

  //----------------------------------------------------------------
  // ユーティリティ / ヘルパー関数
  //----------------------------------------------------------------
  function onFailure(error) {
      console.error("An error occurred: ", error);
      Swal.fire({ icon: 'error', title: 'エラーが発生しました', text: error.message });
      showLoading(false);
      const buttons = ['analyzeImagesBtn', 'saveItemBtn', 'saveCoordBtn', 'aiConsultSendBtn'];
      const btnTexts = ['この画像で解析する', '保存する', 'このコーデを保存', '送信'];
      buttons.forEach((id, index) => {
          const btn = document.getElementById(id);
          if (btn && btn.disabled) {
              btn.disabled = false;
              btn.innerHTML = btnTexts[index];
          }
      });
  }

  function showLoading(show) {
      document.getElementById('loading').style.display = show ? "flex" : "none";
  }

  const fileToB64 = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64 = reader.result.split(',')[1];
        const mimeType = reader.result.split(';')[0].split(':')[1];
        resolve({ base64, mimeType });
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
  });

  function getImageUrl(item, size = 400) {
    if (item && item['画像URL']) {
      return `${G_DRIVE_THUMBNAIL_URL_PREFIX}${item['画像URL']}&sz=w${size}`;
    }
    return `https://placehold.co/${size}x${size}/eee/ccc?text=No+Image`;
  }

  async function showConfirmationDialog(config) {
    const defaultConfig = {
      title: '確認',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#c9443a',
      cancelButtonColor: '#6c757d',
      cancelButtonText: 'キャンセル'
    };
    const finalConfig = { ...defaultConfig, ...config };
    const result = await Swal.fire(finalConfig);
    return result.isConfirmed;
  }
</script>
